# 🧪 راهنمای تست سیستم پرداخت

## 🔧 **مرحله 1: رفع مشکل RLS**

### مشکل:
```
PostgrestException(message: new row violates row-level security policy for table "wallets", code: 42501, details: Unauthorized, hint: null)
```

### راه حل:
1. **وارد Supabase Dashboard شوید**
2. **به بخش SQL Editor بروید**
3. **فایل `sql/fix_payment_system_rls.sql` را اجرا کنید**

```sql
-- کپی و paste کنید:
-- فایل sql/fix_payment_system_rls.sql
```

## 🚀 **مرحله 2: تست کامل سیستم**

### **2.1 تست از داشبورد:**
1. **وارد اپلیکیشن شوید**
2. **به داشبورد بروید**
3. **بخش "پرداخت و کیف پول" را پیدا کنید**
4. **روی "تست سیستم پرداخت" کلیک کنید**

### **2.2 تست شارژ کیف پول:**
1. **روی "شارژ کیف پول" کلیک کنید**
2. **مبلغ را وارد کنید (مثلاً 50000 تومان)**
3. **روی "پرداخت" کلیک کنید**
4. **به سایت WordPress هدایت می‌شوید**
5. **پرداخت را انجام دهید**
6. **به اپلیکیشن برمی‌گردید**

## 🔍 **مرحله 3: بررسی لاگ‌ها**

### **لاگ‌های موفق:**
```
I/flutter: جلسه پرداخت ایجاد شد: session_1234567890_user123
I/flutter: کیف پول جدید ایجاد شد برای کاربر: user123
I/flutter: پرداخت موفق: session_1234567890_user123
```

### **لاگ‌های خطا:**
```
E/flutter: خطا در ایجاد کیف پول: PostgrestException
E/flutter: خطا در دریافت کیف پول: PostgrestException
```

## 🛠️ **مرحله 4: عیب‌یابی**

### **اگر RLS مشکل داشت:**
1. **فایل SQL را دوباره اجرا کنید**
2. **Supabase را restart کنید**
3. **دوباره تست کنید**

### **اگر Edge Function مشکل داشت:**
1. **Environment variables را بررسی کنید**
2. **Edge Function را دوباره deploy کنید**
3. **لاگ‌های Edge Function را بررسی کنید**

### **اگر WordPress مشکل داشت:**
1. **PHP کد را بررسی کنید**
2. **API keys را بررسی کنید**
3. **Network connection را بررسی کنید**

## 📱 **مرحله 5: تست نهایی**

### **تست کامل:**
1. **شارژ کیف پول** ✅
2. **بازگشت از پرداخت** ✅
3. **به‌روزرسانی موجودی** ✅
4. **تست deeplink** ✅

### **نتیجه موفق:**
- کیف پول ایجاد شد
- موجودی به‌روزرسانی شد
- لاگ‌ها پاک هستند
- سیستم کار می‌کند

## 🎯 **نکات مهم:**

1. **همیشه RLS را بررسی کنید**
2. **Environment variables را درست تنظیم کنید**
3. **لاگ‌ها را بررسی کنید**
4. **تست کامل انجام دهید**

## 🆘 **در صورت مشکل:**

1. **لاگ‌ها را کپی کنید**
2. **مشکل را توضیح دهید**
3. **کد SQL را بررسی کنید**
4. **دوباره تست کنید**

---

**🎉 اگر همه چیز درست کار کرد، سیستم پرداخت شما آماده است!**
