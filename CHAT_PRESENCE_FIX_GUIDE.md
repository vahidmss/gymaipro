# راهنمای حل مشکل Chat Presence

## 🚨 مشکل
نوتیفیکیشن‌ها حتی وقتی کاربر در چت نیست هم ارسال نمی‌شوند، چون سیستم `chat_presence` درست کار نمی‌کند.

## 🔍 علت مشکل
1. **حذف رکوردها**: وقتی کاربر از چت خارج می‌شود، رکورد حذف می‌شود
2. **عدم به‌روزرسانی**: `is_active` به `false` تنظیم نمی‌شود
3. **رکوردهای قدیمی**: رکوردهای قدیمی پاک نمی‌شوند

## ✅ راه حل

### 1. اصلاح ChatPresenceService
- `markUserAsInactiveInChat` حالا `is_active` را `false` می‌کند (به جای حذف)
- متد `cleanupInactivePresence` اضافه شد
- متد `cleanupOldPresence` بهبود یافت

### 2. صفحه مدیریت Chat Presence
- **مسیر**: تنظیمات → "مدیریت Chat Presence"
- **ویژگی‌ها**:
  - بررسی تمام حضورها
  - بررسی فقط حضورهای فعال
  - پاک کردن حضورهای غیرفعال
  - پاک کردن حضورهای قدیمی
  - پاک کردن تمام حضورها

## 🛠️ مراحل حل مشکل

### مرحله 1: بررسی وضعیت فعلی
1. **تنظیمات** → "مدیریت Chat Presence"
2. **"بررسی همه"** را بزنید
3. ببینید که چه رکوردهایی وجود دارند

### مرحله 2: پاک کردن رکوردهای قدیمی
1. **"پاک کردن غیرفعال"** را بزنید
2. **"پاک کردن قدیمی"** را بزنید
3. **"بررسی همه"** را دوباره بزنید

### مرحله 3: تست سیستم
1. **تنظیمات** → "تست نوتیفیکیشن Background"
2. **"بررسی حضور"** را بزنید
3. مطمئن شوید که هیچ حضور فعالی ندارید

### مرحله 4: تست واقعی
1. **از یک دستگاه دیگر** پیام بفرستید
2. **اپ گیرنده را ببندید**
3. **منتظر نوتیفیکیشن باشید**

## 🔧 کدهای اصلاح شده

### ChatPresenceService
```dart
// قبل (حذف رکورد):
await _supabase
    .from('chat_presence')
    .delete()
    .eq('user_id', userId)
    .eq('conversation_id', conversationId);

// بعد (تنظیم is_active = false):
await _supabase
    .from('chat_presence')
    .update({'is_active': false})
    .eq('user_id', userId)
    .eq('conversation_id', conversationId);
```

### متدهای جدید
```dart
// پاک کردن حضورهای غیرفعال
Future<void> cleanupInactivePresence() async {
  await _supabase
      .from('chat_presence')
      .delete()
      .eq('is_active', false);
}
```

## 📊 بررسی وضعیت

### SQL Queries مفید
```sql
-- بررسی تمام حضورها
SELECT * FROM chat_presence ORDER BY created_at DESC;

-- بررسی حضورهای فعال
SELECT * FROM chat_presence WHERE is_active = true;

-- بررسی حضورهای غیرفعال
SELECT * FROM chat_presence WHERE is_active = false;

-- پاک کردن حضورهای غیرفعال
DELETE FROM chat_presence WHERE is_active = false;

-- پاک کردن حضورهای قدیمی (بیش از 24 ساعت)
DELETE FROM chat_presence WHERE created_at < NOW() - INTERVAL '24 hours';
```

## 🚨 نکات مهم

### 1. قبل از تست
- **تمام حضورهای قدیمی را پاک کنید**
- **مطمئن شوید که هیچ حضور فعالی ندارید**
- **Device tokens را بررسی کنید**

### 2. بعد از تست
- **حضورهای جدید را بررسی کنید**
- **مطمئن شوید که درست کار می‌کند**
- **رکوردهای قدیمی را پاک کنید**

### 3. نگهداری
- **هر چند روز یکبار حضورهای قدیمی را پاک کنید**
- **حضورهای غیرفعال را پاک کنید**
- **وضعیت سیستم را بررسی کنید**

## ✅ موفقیت
اگر بعد از این تغییرات، نوتیفیکیشن‌ها درست کار کنند، مشکل حل شده است!

## 🔧 نگهداری مداوم
- **هفته‌ای یکبار**: حضورهای قدیمی را پاک کنید
- **ماهانه**: کل سیستم را بررسی کنید
- **در صورت مشکل**: از صفحه مدیریت استفاده کنید
