# 💰 راهنمای نهایی تنظیم کیف پول

## 🎯 **وضعیت فعلی:**
- ✅ جدول `wallets` موجود است
- ✅ ساختار کامل با تمام ستون‌ها
- ✅ RLS نیاز به تنظیم دارد

## 🔧 **مرحله 1: تنظیم RLS**

### **فایل SQL:** `sql/setup_wallets_rls.sql`

```sql
-- فعال کردن RLS
ALTER TABLE wallets ENABLE ROW LEVEL SECURITY;

-- حذف policies قدیمی
DROP POLICY IF EXISTS "wallets_policy" ON wallets;

-- ایجاد policy ساده
CREATE POLICY "wallets_policy" ON wallets
  FOR ALL USING (true) WITH CHECK (true);
```

## 🚀 **مرحله 2: تست سیستم**

### **2.1 تست ایجاد کیف پول:**
1. **وارد اپلیکیشن شوید**
2. **به داشبورد بروید**
3. **روی "شارژ کیف پول" کلیک کنید**
4. **لاگ‌ها را بررسی کنید**

### **2.2 لاگ‌های مورد انتظار:**
```
I/flutter: دریافت کیف پول برای کاربر: 0618fd07-14f0-49f8-9570-b008f0ec8f1f
I/flutter: کیف پول وجود ندارد، در حال ایجاد کیف پول جدید...
I/flutter: شروع ایجاد کیف پول جدید برای کاربر: 0618fd07-14f0-49f8-9570-b008f0ec8f1f
I/flutter: ✅ کیف پول جدید با موفقیت ایجاد شد برای کاربر: 0618fd07-14f0-49f8-9570-b008f0ec8f1f
I/flutter: کیف پول ID: 12345678-1234-1234-1234-123456789012
```

## 📱 **مرحله 3: تست کامل**

### **3.1 تست شارژ کیف پول:**
1. **مبلغ را وارد کنید** (مثلاً 50000 تومان)
2. **روی "پرداخت" کلیک کنید**
3. **به سایت WordPress هدایت می‌شوید**
4. **پرداخت را انجام دهید**
5. **به اپلیکیشن برمی‌گردید**

### **3.2 بررسی نتیجه:**
- ✅ کیف پول ایجاد شد
- ✅ موجودی به‌روزرسانی شد
- ✅ لاگ‌ها پاک هستند

## 🛠️ **مرحله 4: عیب‌یابی**

### **اگر RLS مشکل داشت:**
```sql
-- اجرای فوری:
ALTER TABLE wallets DISABLE ROW LEVEL SECURITY;
ALTER TABLE wallets ENABLE ROW LEVEL SECURITY;
CREATE POLICY "wallets_policy" ON wallets FOR ALL USING (true) WITH CHECK (true);
```

### **اگر ستون مشکل داشت:**
- کد Flutter با ساختار جدول تطبیق داده شده
- تمام ستون‌های مورد نیاز اضافه شده

## ✅ **نتیجه موفق:**

### **لاگ‌های موفق:**
```
I/flutter: ✅ کیف پول جدید با موفقیت ایجاد شد
I/flutter: جلسه پرداخت ایجاد شد: session_1234567890_user123
I/flutter: پرداخت موفق: session_1234567890_user123
```

### **لاگ‌های خطا:**
```
E/flutter: ❌ خطا در ایجاد کیف پول: PostgrestException
```

## 🎯 **مراحل نهایی:**

1. **فایل SQL را اجرا کنید** (`sql/setup_wallets_rls.sql`)
2. **دوباره تست کنید**
3. **لاگ‌ها را بررسی کنید**
4. **اگر کار کرد، سیستم آماده است**

---

**🎉 حالا سیستم کیف پول کاملاً آماده است!**
